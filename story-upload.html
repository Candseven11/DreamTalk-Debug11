<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Your Story - DreamTalk Box</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* 样式略，保持原样 */
    body {
      background-color: #fcf2f7;
      color: #5a3d5c;
      font-family: 'Arial Rounded MT Bold', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      flex: 1;
    }
    .upload-container {
      background-color: white;
      border-radius: 30px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      margin-bottom: 40px;
    }
    footer {
      text-align: center;
      padding: 30px 0;
      color: #9d7e9f;
      font-size: 0.9rem;
      background-color: white;
      margin-top: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button onclick="location.href='index.html'">Back</button>
      <h1>DreamTalk Box</h1>
    </header>

    <div class="upload-container">
      <h1>Create Your Own Story</h1>
      <form id="story-form">
        <label for="story-title">Title</label>
        <input type="text" id="story-title" required />

        <label for="story-content">Content</label>
        <textarea id="story-content" required></textarea>

        <button type="submit">Upload</button>
      </form>
      <p id="status"></p>
    </div>
  </div>

  <footer>
    <p>© 2023 DreamTalk Box. All rights reserved.</p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4fhwhOOFF7CBEWYnOplLiAh021905LAQ",
      authDomain: "dreamtalk-91c96.firebaseapp.com",
      projectId: "dreamtalk-91c96",
      storageBucket: "dreamtalk-91c96.appspot.com",
      messagingSenderId: "1073825503044",
      appId: "1:1073825503044:web:c70d0c119795b66dab6911",
      measurementId: "G-XJZE5QM6W0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const statusElement = document.getElementById('status');

    function updateStatus(message) {
      statusElement.textContent = message;
    }

    auth.signInAnonymously().catch((error) => {
      updateStatus('Error signing in: ' + error.message);
    });

    document.getElementById('story-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const title = document.getElementById('story-title').value.trim();
      const content = document.getElementById('story-content').value.trim();

      if (!title || !content) {
        updateStatus('Please fill in all fields');
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        updateStatus('Signing you in, please wait...');
        auth.onAuthStateChanged((newUser) => {
          if (newUser) {
            uploadStory(newUser, title, content);
          }
        });
        return;
      }

      uploadStory(user, title, content);
    });

    function uploadStory(user, title, content) {
      updateStatus('Uploading your story...');
      const storyData = {
        title: title,
        content: content,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection('users').doc(user.uid).collection('stories').add(storyData)
        .then((docRef) => {
          updateStatus('Story uploaded successfully!');
          document.getElementById('story-form').reset();
          setTimeout(() => {
            window.location.href = 'my-stories.html';
          }, 2000);
        })
        .catch((error) => {
          updateStatus('Error uploading story: ' + error.message);
        });
    }
  </script>
</body>
</html>
